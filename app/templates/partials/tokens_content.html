{% from "components/stats_card.html" import stat_card %}

<!-- Summary Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  {{ stat_card("총 비용", "$" ~ "%.2f" | format(overview.total_cost_usd), color="orange") }}
  {{ stat_card("캐시 효율", cache_efficiency.efficiency_pct | string ~ "%",
     subtitle="캐시 읽기 / 전체 입력", color="green") }}
  {{ stat_card("캐시 읽기", "{:,}".format(cache_efficiency.cache_read_tokens),
     subtitle="토큰", color="blue") }}
  {{ stat_card("직접 입력", "{:,}".format(cache_efficiency.direct_input_tokens),
     subtitle="토큰", color="purple") }}
</div>

<!-- Cache Efficiency Gauge -->
<div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
  <h2 class="text-lg font-semibold mb-4">캐시 효율</h2>
  <div class="w-full bg-gray-700 rounded-full h-8 overflow-hidden">
    <div class="h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all"
         style="width: {{ cache_efficiency.efficiency_pct }}%; background: linear-gradient(90deg, #10b981, #3b82f6);">
      {{ cache_efficiency.efficiency_pct }}% 캐시 히트
    </div>
  </div>
  <div class="flex justify-between text-xs text-gray-400 mt-2">
    <span>직접 입력: {{ "{:,}".format(cache_efficiency.direct_input_tokens) }}</span>
    <span>캐시 생성: {{ "{:,}".format(cache_efficiency.cache_creation_tokens) }}</span>
    <span>캐시 읽기: {{ "{:,}".format(cache_efficiency.cache_read_tokens) }}</span>
  </div>
</div>

<!-- Daily Token Chart -->
<div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
  <h2 class="text-lg font-semibold mb-4">일별 토큰 사용량</h2>
  <div class="chart-container">
    <canvas id="dailyTokenChart"></canvas>
  </div>
</div>

<!-- Model Cost Table -->
<div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-4">
  <h2 class="text-lg font-semibold mb-4">모델별 비용 분석</h2>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-gray-400 border-b border-gray-700">
          <th class="text-left py-3 px-4">모델</th>
          <th class="text-right py-3 px-4">입력</th>
          <th class="text-right py-3 px-4">출력</th>
          <th class="text-right py-3 px-4">캐시 읽기</th>
          <th class="text-right py-3 px-4">캐시 생성</th>
          <th class="text-right py-3 px-4">비용</th>
        </tr>
      </thead>
      <tbody>
        {% for m in model_costs %}
        <tr class="border-b border-gray-700/50 hover:bg-gray-700/30">
          <td class="py-3 px-4 font-medium">{{ m.display_name }}</td>
          <td class="py-3 px-4 text-right text-gray-300">{{ "{:,}".format(m.input_tokens) }}</td>
          <td class="py-3 px-4 text-right text-gray-300">{{ "{:,}".format(m.output_tokens) }}</td>
          <td class="py-3 px-4 text-right text-gray-300">{{ "{:,}".format(m.cache_read_tokens) }}</td>
          <td class="py-3 px-4 text-right text-gray-300">{{ "{:,}".format(m.cache_creation_tokens) }}</td>
          <td class="py-3 px-4 text-right font-semibold text-orange-400">${{ "%.2f" | format(m.cost_usd) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="text-right text-xs text-gray-500">갱신: {{ updated_at }}</div>

<script>
  (function() {
    const dailyBreakdown = {{ daily_breakdown | tojson }};

    createBarChart('dailyTokenChart', {
      labels: dailyBreakdown.map(d => d.date.slice(5)),
      datasets: [
        {
          label: '출력',
          data: dailyBreakdown.map(d => d.output),
          backgroundColor: '#f97316',
          borderRadius: 2,
        },
        {
          label: '입력',
          data: dailyBreakdown.map(d => d.input),
          backgroundColor: '#3b82f6',
          borderRadius: 2,
        },
        {
          label: '캐시 읽기',
          data: dailyBreakdown.map(d => d.cache_read),
          backgroundColor: '#10b981',
          borderRadius: 2,
        },
      ],
      stacked: true,
    });
  })();
</script>
