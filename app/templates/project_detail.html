{% extends "base.html" %}

{% block content %}
{% if stats %}
<!-- Header -->
<div class="mb-6">
  <a href="/projects" class="text-sm text-gray-400 hover:text-white">&larr; 프로젝트 목록</a>
  <h1 class="text-2xl font-bold mt-2">{{ stats.project_name }}</h1>
  <div class="text-sm text-gray-400 mt-1">{{ stats.project_path }}</div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
  <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
    <div class="text-xs text-gray-400">세션</div>
    <div class="text-xl font-bold text-blue-400">{{ stats.session_count }}</div>
  </div>
  <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
    <div class="text-xs text-gray-400">메시지</div>
    <div class="text-xl font-bold text-green-400">{{ "{:,}".format(stats.total_messages) }}</div>
  </div>
  <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
    <div class="text-xs text-gray-400">도구 호출</div>
    <div class="text-xl font-bold text-purple-400">{{ "{:,}".format(stats.tool_calls_count) }}</div>
  </div>
  <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
    <div class="text-xs text-gray-400">비용</div>
    <div class="text-xl font-bold text-orange-400">${{ "%.2f" | format(stats.total_cost_usd) }}</div>
  </div>
</div>

<!-- Token Summary -->
<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
  <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
    <div class="text-xs text-gray-400">입력 토큰</div>
    <div class="text-lg font-bold text-gray-200">{{ "{:,}".format(stats.total_usage.input_tokens) }}</div>
  </div>
  <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
    <div class="text-xs text-gray-400">출력 토큰</div>
    <div class="text-lg font-bold text-gray-200">{{ "{:,}".format(stats.total_usage.output_tokens) }}</div>
  </div>
  <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
    <div class="text-xs text-gray-400">캐시 읽기</div>
    <div class="text-lg font-bold text-gray-200">{{ "{:,}".format(stats.total_usage.cache_read_input_tokens) }}</div>
  </div>
  <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
    <div class="text-xs text-gray-400">캐시 생성</div>
    <div class="text-lg font-bold text-gray-200">{{ "{:,}".format(stats.total_usage.cache_creation_input_tokens) }}</div>
  </div>
</div>

<!-- Models -->
{% if stats.models_used %}
<div class="flex flex-wrap gap-2 mb-8">
  {% for model in stats.models_used %}
  <span class="text-sm px-3 py-1 bg-gray-800 text-gray-300 rounded-lg border border-gray-700">{{ get_model_display_name(model) }}</span>
  {% endfor %}
</div>
{% endif %}

<!-- Charts Row -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
  {% if daily_counts %}
  <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
    <h2 class="text-lg font-semibold mb-4">일별 세션 추이</h2>
    <div class="chart-container" style="height: 250px;">
      <canvas id="dailyChart"></canvas>
    </div>
  </div>
  {% endif %}
  {% if tool_freq %}
  <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
    <h2 class="text-lg font-semibold mb-4">도구 사용 빈도</h2>
    <div class="chart-container" style="height: 250px;">
      <canvas id="toolChart"></canvas>
    </div>
  </div>
  {% endif %}
</div>

<!-- Session List -->
<div class="mb-4">
  <h2 class="text-lg font-semibold mb-4">세션 목록</h2>
  <div class="space-y-2">
    {% for s in sessions %}
    <a href="/sessions/{{ s.session_id }}"
       class="block bg-gray-800 rounded-lg p-3 border border-gray-700 hover:border-gray-500 transition-colors">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-0.5">
            {% if s.git_branch %}
            <span class="text-xs px-2 py-0.5 bg-gray-700 rounded text-gray-300">{{ s.git_branch }}</span>
            {% endif %}
            <span class="text-xs text-gray-400">{{ s.session_id[:12] }}...</span>
            <span class="text-xs text-gray-500">{{ s.first_timestamp | kst }}</span>
          </div>
          {% if s.models_used %}
          <div class="text-xs text-gray-400 mt-0.5">{{ get_model_display_names(s.models_used) | join(', ') }}</div>
          {% endif %}
        </div>
        <div class="text-right text-sm flex-shrink-0 ml-4">
          <div class="text-gray-300">{{ s.message_count }}개 메시지</div>
          <div class="text-gray-400 text-xs">{{ s.tool_calls_count }}회 도구</div>
          <div class="text-orange-400 text-xs">{{ "{:,}".format(s.total_usage.output_tokens) }} 출력</div>
        </div>
      </div>
    </a>
    {% endfor %}
  </div>
</div>

<script>
(function() {
  {% if daily_counts %}
  const dailyData = {{ daily_counts | tojson }};
  createBarChart('dailyChart', {
    labels: dailyData.map(d => d[0].substring(5)),
    datasets: [{
      label: '세션',
      data: dailyData.map(d => d[1]),
      backgroundColor: '#3b82f6',
      borderRadius: 4,
    }],
  });
  {% endif %}

  {% if tool_freq %}
  const toolData = {{ tool_freq | tojson }};
  createHorizontalBarChart('toolChart', {
    labels: toolData.map(d => d[0]),
    datasets: [{
      label: '사용 횟수',
      data: toolData.map(d => d[1]),
      backgroundColor: '#8b5cf6',
      borderRadius: 4,
    }],
  });
  {% endif %}
})();
</script>

{% else %}
<div class="text-center text-gray-400 py-20">
  <h2 class="text-xl mb-2">프로젝트를 찾을 수 없습니다</h2>
  <a href="/projects" class="text-blue-400 hover:underline">프로젝트 목록으로</a>
</div>
{% endif %}
{% endblock %}
